#  "Сервер картинок"

## **1. Описание сервиса**


Учебный проект в виде
веб-приложения для просмотра и хранения картинок в пользователей.
Пользователь загружает фотки или картинки,
а взамен получает прямые вечные ссылки на них.
Эти ссылки можно использовать где угодно — в соцсетях, блогах или просто отправить друзьям.

### **Технологии и основные условия**

- Бэк-енд  на Python3.12, модуль httpServer.
- Nginx — для раздачи контента.
- Всё упаковано в Docker-контейнеры.
- Docker Compose для управления контейнерами.
- Поддерживаемые форматы для загрузки: .jpg, .png, .gif, максимум 5MB на 1 файл.
- Логирование  - Python модуль loguru.
- Безопасность - Python модуль Pillow.


### **Основные модули сервиса**

1. Python-Бэк-енд (app.py, ImageHostingHandler.py, advanced_http_request_handler.py) выполняет обработку запросов, загрузку изображений и логирования действий пользователей.
2. Nginx раздаёт загруженные изображения и проксирует маршруты для загрузки и получения статических файлов.
3. Docker-контейнер, с Docker Compose для управления.
4. Образ контейнера Nginx автоматически загружается и запускается в Docker.
5. Docker Volumes монтируются к серверу Nginx для долговременного хранения изображений, файлов и логов.
6. Интерфейс для взаимодействия с пользователем - HTML, JS, CSS.

Дизайн - https://www.figma.com/design/ivhGgfIBMDsA2xF3qospb6/image-hosting?node-id=0-1&p=f


### **Файлы сервиса**

- Dockerfile:
- Для Python-Бэк-енда с использованием multi-stage build.
- compose.yaml:
- Конфигурация для объединения контейнеров.
- nginx.conf:
- Конфигурация Nginx для раздачи изображений и проксирования запросов.
- app.py:
- Основной скрипт Python-Бэк-енда.
- requirements.txt:
- Список зависимостей Python.
- settings.py:
- Хранение базовых констант приложения


### **Структура**

**Директории и файлы:**
```text
project/
├── app.py                # Основной Python-Бэк-енд
├── requirements.txt      # Зависимости Python
├── Dockerfile            # Dockerfile для Python-Бэк-енда
├── docker-compose.yml    # Конфигурация Docker Compose
├── nginx.conf            # Конфигурация Nginx
├── images/               # Папка для хранения загруженных изображений (volume)
├── logs/                 # Папка для логов (volume)
├── settings.py           # Хранение всех констант
└── static/               # Дополнительные статические файлы (CSS/JS, если применимо)

```

___

## **2. Функционал**

###  Основной функционал:

**1. Главная страница**

- **Маршрут:** `/`
- Функциональность:
  - Встречает пользователя приветственным сообщением и рассказывает о сервисе.
  - Содержит ссылки на основные маршруты:
  - Страница загрузки изображений (`/upload`).
  - Каталог загруженных изображений (`/images/`).

**2. Загрузка изображений**

- **Маршрут:** `/api/upload`
- **Метод:** `POST`
- Функциональность:
   - Принимает файл изображения от пользователя через HTTP-запрос.
   - Поддерживаемые форматы: `.jpg`, `.jpeg`, `.png`, `.gif`.
   - Ограничение размера файла: до 5 МБ.
   - Генерирует уникальное имя для каждого загружаемого изображения.
   - Сохраняет изображение в папку `/images` на сервере.
   - Возвращает пользователю уникальный идентификатор файла и ссылку на изображение.

**3. Доступ к загруженным изображениям**

- **Маршрут:** `/images/<имя_файла>`
- Функциональность:
   - Все загруженные изображения доступны для просмотра и скачивания по прямым ссылкам.
   - Nginx обслуживает этот маршрут, раздавая файлы из папки `/images`.

**4. Логирование действий**

- Функциональность:
  - Записывает каждое действие пользователя в лог-файл `app.log`.
- Формат записи:
   ```txt
   [Дата/время] Действие: сообщение
   ```
Примеры записей:
   ```text
   [2025-01-24 14:00:00] Успех: изображение img1.jpg загружено.
   [2025-01-24 14:01:00] Ошибка: неподдерживаемый формат файла (user_file.txt).
   ```
- Логи хранятся в отдельном томе Docker и доступны в папке app/logs на бэк-энде.

**5. Условия использования и информация для пользователей**

- **Маршрут:** `/terms.html`
- Функциональность:
   - Сообщает пользователю основные требования к загружаемому контенту, правах, ответственности сторон и ограничениях.

------


### **Пользовательские сценарии**

**1. Загрузка изображения**
1. Пользователь переходит на маршрут `/upload`.
2. Загружает файл через HTTP-запрос с помощью формы.
3. Бэк-енд проверяет формат и размер файла.
4. Если файл успешно загружен:
   - Он сохраняется в папке `/images`.
   - Пользователю возвращается сообщение с уникальной ссылкой на файл.
5. Если файл не соответствует требованиям:
   - Пользователю возвращается сообщение об ошибке.

**2. Просмотр загруженных изображений**
1. Пользователь переходит по ссылке `/images/<имя_файла>`.
2. Nginx возвращает запрошенное изображение для просмотра или скачивания.

------


### **Масштабируемость**

- Проект ориентирован на учебные цели, но спроектирован таким образом, чтобы при необходимости:
- Доступно увеличение количества Бэк-енд-серверов для обработки загрузок.
- Доступно расширение хранилища изображений или подключение облачного хранилища.
- Доступно добавление функционала авторизации пользователей, хранения сессий и базы данных.
- Доступно добавление новых маршрутов для расширения пользовательского интерфейса и интеграции.


### **Контейнеризация**

- Все сервисы (Бэк-енд и Nginx) нужно упаковать в отдельные Docker-контейнеры.
- Управление контейнерами нужно организовать с помощью Docker Compose.
- Должны быть использованы два тома:
- `images`: для хранения загруженных изображений.
- `logs`: для сохранения логов.


### **Развёртывание и запуск**

Установите Docker и Docker Compose.

Чтобы запустить проект, достаточно одной команды:

 ```bash
 docker compose up --build
 ```

- Все зависимости включены в `Dockerfile` и `compose.yaml`.

------

### **Безопасность**


**Проверка расширений и размеров загружаемых файлов:**
- Только картинки (jpg, png, gif) — никаких вредоносных файлов
- Максимальный размер одного файла не превышает 5МВ
- Валидация изображений - модуль pillow Python.

**Защита доступа к файлам:**
- Картинки доступны только по специальным ссылкам вида `/images/название_файла`
- Проксирование Nginx не допускает скачивание файлов без уникальной ссылки


### **Хранилище данных Docker volume**

- **Изображения:** хранятся в папке `/images`, монтируемой как volume.
- **Логи:** хранятся в папке `/logs`, монтируемой как volume.
- **Долговременность данных:** том Docker сохраняет все файлы между перезапусками контейнеров.


### **Доступ фронт-энд**

- Приложение доступно:
- Бэк-енд по адресу: `http://localhost:8000`.
- Статические изображения через Nginx по адресу: `http://localhost:80/images/<имя_файла>`.


## **3. Архитектура и структура**

### **Общая архитектура**

Система состоит из двух основных компонентов:
1. **Python-Бэк-енд:**
- Отвечает за обработку HTTP-запросов, загрузку изображений, валидацию данных и логирование.
- Выполняет бизнес-логику приложения, связанную с управлением загруженными файлами.
- Работает внутри Docker-контейнера, слушая запросы на порту `8000`.

2. **Nginx-сервер:**
- Раздает статические файлы и загруженные изображения по маршруту `/images/`.
- Проксирует запросы на Python-Бэк-енд для других маршрутов.
- Работает в отдельном Docker-контейнере, слушая запросы на порту `80`.

Компоненты взаимодействуют через локальную сеть, созданную с помощью Docker Compose.

### **Взаимодействие компонентов**

**Когда пользователь загружает картинку:**
1. Пользователь отправляет файл через `POST /upload` на Python-Бэк-енд.
2. Бэк-енд берет всю работу на себя:
    - Проверяет, всё ли в порядке с файлом
    - Придумывает ему уникальное имя
    - Сохраняет в папку `/images` через Docker volume
    - Записывает в лог, что и когда загрузили
    - Отдает пользователю ссылку на его картинку

**Когда пользователь хочет посмотреть картинку:**
1. Запрашивает картинку через `GET /images/<имя_файла>` у Nginx
2. Nginx ищет файл в папке `/images`
3. Если нашел - отдает картинку пользователю

**Кто за что отвечает:**
- Python-Бэк-енд — "умная" часть: проверяет файлы, обрабатывает загрузки
- Nginx — "быстрая" часть: раздает картинки и работает как прокси


**Описание ключевых компонентов:**
1. **app.py:**
- Реализует обработку HTTP-запросов:
    - `GET /` — главная страница.
    - `POST /upload` — загрузка изображения.
- Выполняет:
    - Валидацию загружаемого файла (формат, размер).
    - Сохранение файла в папку `/images`.
    - Логирование действий в файл `app.log`.
  
2. **nginx.conf:**
- Раздает содержимое папки `/images` по маршруту `/images/<имя_файла>`.
- Проксирует запросы, не связанные со статикой, на Python-Бэк-енд.

3. **compose.yaml:**
- Определяет два сервиса:
    - `app` — Python-Бэк-енд.
    - `nginx` — Nginx-сервер.
- Создает два тома:
    - `images` — для хранения загруженных изображений.
    - `logs` — для хранения логов.
  
4. **images/:**
- Каталог, в который сохраняются все загруженные файлы.
- Подключается как volume для долговременного хранения.

5. **logs/:**
- Каталог, содержащий лог-файлы (`app.log`).
- Подключается как volume для сохранности данных между перезапусками.


### **Взаимодействие через сеть**

- Порты и маршруты:
    - Python-Бэк-енд:
    - Внешний порт: `8000` (для локальной отладки).
    - Nginx:
    - Внешний порт: `80` (для пользователей).
    - Внутренняя сеть Docker связывает два контейнера:
    - Nginx обращается к Python-Бэк-енду по адресу `http://app:8000`.


### **Логическая схема**

1. **Пользовательский запрос:**
   Пользователь взаимодействует с системой через маршруты:
   - `/` — главная страница (обрабатывается Бэк-ендом).
   - `/upload` — загрузка изображения (обрабатывается Бэк-ендом).
   - `/images/<имя_файла>` — доступ к изображению (обрабатывается Nginx).

2. **Обработка запросов:**
   - Nginx:
       - Раздает статические файлы и загруженные изображения.
       - Переадресует запросы на Python-Бэк-енд, если маршрут не связан с интерфейсом и изображениями.
   - Python-Бэк-енд:
       - Принимает и обрабатывает запросы `/` и `/upload`.
       - Сохраняет изображения и записывает логи.
     
3. **Хранение данных:**
   - Изображения:
       - хранятся в volume, подключенном как `/images`.
   - Логи:
       - хранятся в volume, подключенном как `/logs`.

------

### **Поток данных**

1. **Загрузка изображения:**
   - Пользователь отправляет файл на маршрут `/upload`.
   - Python-Бэк-енд:
       - Проверяет файл.
       - Сохраняет файл в `/images`.
       - Логирует действие.
   - Пользователю возвращается ссылка вида `/images/<имя_файла>`.
   
2. **Доступ к изображению:**
   - Пользователь отправляет запрос на `/images/<имя_файла>`.
   - Nginx проверяет файл в папке `/images` и возвращает его.

___